# Peripheral Drivers

<details>
<summary>Relevant source files</summary>

The following files were used as context for generating this wiki page:

- [.mxproject](.mxproject)
- [Core/Inc/main.h](Core/Inc/main.h)
- [Core/Inc/stm32f1xx_hal_conf.h](Core/Inc/stm32f1xx_hal_conf.h)

</details>



This page provides an overview of all hardware peripheral drivers used in the STM32-TFTLCD-UI system. It documents the initialization functions, configuration patterns, and interdependencies between peripherals. Each peripheral has dedicated initialization code generated by STM32CubeMX and is managed through the STM32 HAL (Hardware Abstraction Layer).

For detailed HAL configuration and module selection, see [HAL Configuration](#3.1). For the system initialization sequence, see [System Initialization](#3.2). For interrupt handler implementations, see [Interrupt System](#3.3).

## Peripheral Overview

The system uses seven hardware peripherals to implement the calendar/clock UI with automatic brightness control:

| Peripheral | Purpose | HAL Module | Initialization Function |
|------------|---------|------------|------------------------|
| **GPIO** | Digital I/O for keys, LEDs, LCD backlight | `HAL_GPIO_MODULE_ENABLED` | `MX_GPIO_Init()` |
| **ADC3** | Analog-to-digital conversion for light sensor | `HAL_ADC_MODULE_ENABLED` | `MX_ADC3_Init()` |
| **DMA1/DMA2** | Direct memory access for ADC and USART | `HAL_DMA_MODULE_ENABLED` | `MX_DMA_Init()` |
| **FSMC** | Memory controller for TFT LCD interface | `HAL_SRAM_MODULE_ENABLED` | `MX_FSMC_Init()` |
| **RTC** | Real-time clock for calendar/timekeeping | `HAL_RTC_MODULE_ENABLED` | `MX_RTC_Init()` |
| **TIM2/4/7** | Timers for time base and PWM generation | `HAL_TIM_MODULE_ENABLED` | `MX_TIM2_Init()`, `MX_TIM4_Init()`, `MX_TIM7_Init()` |
| **USART1** | Serial communication for debugging | `HAL_UART_MODULE_ENABLED` | `MX_USART1_UART_Init()` |

**Sources: ** [Core/Inc/stm32f1xx_hal_conf.h:36-78](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Inc/stm32f1xx_hal_conf.h#L36-L78), [.mxproject:26-32](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L26-L32)

## Peripheral Architecture

The following diagram shows the relationships between peripheral drivers, their HAL modules, and the hardware they control:

```mermaid
graph TB
    subgraph "Peripheral Driver Layer"
        GPIO_INIT["MX_GPIO_Init()<br/>Core/Src/gpio.c"]
        ADC_INIT["MX_ADC3_Init()<br/>Core/Src/adc.c"]
        DMA_INIT["MX_DMA_Init()<br/>Core/Src/dma.c"]
        FSMC_INIT["MX_FSMC_Init()<br/>Core/Src/fsmc.c"]
        RTC_INIT["MX_RTC_Init()<br/>Core/Src/rtc.c"]
        TIM_INIT["MX_TIM2_Init()<br/>MX_TIM4_Init()<br/>MX_TIM7_Init()<br/>Core/Src/tim.c"]
        UART_INIT["MX_USART1_UART_Init()<br/>Core/Src/usart.c"]
    end
    
    subgraph "HAL Driver Layer"
        HAL_GPIO["HAL_GPIO_MODULE"]
        HAL_ADC["HAL_ADC_MODULE"]
        HAL_DMA["HAL_DMA_MODULE"]
        HAL_SRAM["HAL_SRAM_MODULE"]
        HAL_RTC["HAL_RTC_MODULE"]
        HAL_TIM["HAL_TIM_MODULE"]
        HAL_UART["HAL_UART_MODULE"]
    end
    
    subgraph "Hardware Peripherals"
        HW_GPIO["GPIO Ports<br/>GPIOA, GPIOB, GPIOE"]
        HW_ADC["ADC3<br/>Channel 10"]
        HW_DMA["DMA1 (Ch4/5)<br/>DMA2 (Ch5)"]
        HW_FSMC["FSMC Bank 4<br/>16-bit Bus"]
        HW_RTC["RTC<br/>LSI Clock"]
        HW_TIM["TIM2, TIM4, TIM7"]
        HW_UART["USART1<br/>PA9/PA10"]
    end
    
    GPIO_INIT --> HAL_GPIO
    ADC_INIT --> HAL_ADC
    DMA_INIT --> HAL_DMA
    FSMC_INIT --> HAL_SRAM
    RTC_INIT --> HAL_RTC
    TIM_INIT --> HAL_TIM
    UART_INIT --> HAL_UART
    
    HAL_GPIO --> HW_GPIO
    HAL_ADC --> HW_ADC
    HAL_DMA --> HW_DMA
    HAL_SRAM --> HW_FSMC
    HAL_RTC --> HW_RTC
    HAL_TIM --> HW_TIM
    HAL_UART --> HW_UART
    
    HW_ADC -.->|"Uses DMA2 Ch5"| HW_DMA
    HW_UART -.->|"Uses DMA1 Ch4/5"| HW_DMA
```

**Sources: ** [.mxproject:26-37](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L26-L37), [Core/Inc/stm32f1xx_hal_conf.h:36-78](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Inc/stm32f1xx_hal_conf.h#L36-L78)

## Initialization Sequence

Peripheral initialization follows a strict ordering to handle dependencies correctly. The sequence is executed in `main()` after HAL and system clock initialization:

```mermaid
sequenceDiagram
    participant Main as main()
    participant GPIO as MX_GPIO_Init()
    participant DMA as MX_DMA_Init()
    participant Peripherals as Peripheral Init Functions
    participant Hardware as Hardware Registers
    
    Main->>GPIO: Initialize GPIO first
    GPIO->>Hardware: Configure pin modes, speeds, pulls
    Note over GPIO: Keys, LEDs, LCD_BL pins
    
    Main->>DMA: Initialize DMA controllers
    DMA->>Hardware: Configure DMA1 & DMA2 channels
    Note over DMA: Must precede ADC & USART init
    
    Main->>Peripherals: MX_FSMC_Init()
    Peripherals->>Hardware: Configure memory controller
    Note over Peripherals: FSMC Bank 4 for LCD
    
    Main->>Peripherals: MX_TIM2_Init()
    Peripherals->>Hardware: Configure time base timer
    
    Main->>Peripherals: MX_TIM4_Init()
    Peripherals->>Hardware: Configure PWM for beeper
    
    Main->>Peripherals: MX_ADC3_Init()
    Peripherals->>Hardware: Configure ADC with DMA
    Note over Peripherals: Depends on DMA2 Ch5
    
    Main->>Peripherals: MX_RTC_Init()
    Peripherals->>Hardware: Configure real-time clock
    
    Main->>Peripherals: MX_USART1_UART_Init()
    Peripherals->>Hardware: Configure serial port
    Note over Peripherals: Depends on DMA1 Ch4/5
    
    Main->>Peripherals: MX_TIM7_Init()
    Peripherals->>Hardware: Configure auxiliary timer
```

**Key Initialization Dependencies:**
1. **GPIO must initialize first** - Other peripherals rely on pins being configured for alternate functions
2. **DMA must initialize before ADC and USART** - These peripherals use DMA channels for data transfer
3. **FSMC initializes early** - Required for LCD memory-mapped access
4. **Timers initialize after DMA** - Ensures PWM and time base functionality is available

**Sources: ** [Core/Src/main.c:90-120](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Src/main.c#L90-L120) (inferred from typical STM32CubeMX pattern)

## Peripheral Configuration Summary

### GPIO Pin Assignments

The system uses three GPIO ports (A, B, E) for various inputs and outputs:

| Pin | Signal Name | Direction | Purpose | Port |
|-----|-------------|-----------|---------|------|
| PE3 | KEY1 | Input | Decrement button | GPIOE |
| PE4 | KEY0 | Input | Increment button | GPIOE |
| PE5 | LED1 | Output | Status indicator LED | GPIOE |
| PA0 | WK_UP | Input | Wake-up / mode toggle button | GPIOA |
| PB0 | LCD_BL | Output | LCD backlight control | GPIOB |
| PB5 | LED0 | Output | Status indicator LED | GPIOB |
| PB8 | BEEP | Output (TIM4 CH3) | Beeper PWM output | GPIOB |

For detailed GPIO configuration including pull-up/pull-down resistors and interrupt settings, see [GPIO Configuration](#4.1).

**Sources: ** [Core/Inc/main.h:60-73](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Inc/main.h#L60-L73)

### DMA Channel Allocation

The system uses two DMA controllers with specific channel assignments:

| DMA Controller | Channel | Peripheral | Direction | Purpose |
|----------------|---------|------------|-----------|---------|
| **DMA1** | Channel 4 | USART1_TX | Memory-to-Peripheral | UART transmit |
| **DMA1** | Channel 5 | USART1_RX | Peripheral-to-Memory | UART receive |
| **DMA2** | Channel 5 | ADC3 | Peripheral-to-Memory | ADC conversion data |

For detailed DMA configuration including circular mode, data width, and interrupt settings, see [DMA System](#4.7).

**Sources: ** [.mxproject:28](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L28)

### Timer Configurations

Three timers serve different purposes in the system:

| Timer | Mode | Purpose | Configuration Details |
|-------|------|---------|----------------------|
| **TIM2** | Time Base | Task scheduling / 10ms tick | See [Timer Peripherals](#4.5) |
| **TIM4** | PWM Output | Beeper audio generation (Channel 3) | See [Timer Peripherals](#4.5) |
| **TIM7** | Time Base | Auxiliary time base / 100ms tick | See [Timer Peripherals](#4.5) |

**Sources: ** [.mxproject:31](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L31)

## Peripheral Interdependencies

The following diagram illustrates data flow dependencies between peripherals:

```mermaid
graph LR
    subgraph "Input Path"
        LIGHT["Light Sensor<br/>Analog Input"]
        KEYS["Push Buttons<br/>PE3, PE4, PA0"]
    end
    
    subgraph "Processing Peripherals"
        ADC3["ADC3<br/>MX_ADC3_Init()"]
        GPIO_IN["GPIO Input<br/>MX_GPIO_Init()"]
        DMA2["DMA2 Ch5<br/>MX_DMA_Init()"]
    end
    
    subgraph "Control Peripherals"
        RTC["RTC<br/>MX_RTC_Init()"]
        TIM2["TIM2<br/>Time Base"]
        TIM7["TIM7<br/>Time Base"]
    end
    
    subgraph "Output Peripherals"
        FSMC["FSMC<br/>MX_FSMC_Init()"]
        TIM4["TIM4 PWM<br/>MX_TIM4_Init()"]
        GPIO_OUT["GPIO Output<br/>LEDs, Backlight"]
        USART["USART1<br/>MX_USART1_UART_Init()"]
        DMA1["DMA1 Ch4/5<br/>MX_DMA_Init()"]
    end
    
    subgraph "External Devices"
        LCD["TFT LCD<br/>via FSMC"]
        BEEPER["Beeper<br/>PB8"]
        LEDS["LED0, LED1"]
        DEBUG["Debug Terminal"]
    end
    
    LIGHT --> ADC3
    ADC3 --> DMA2
    DMA2 -.->|"adc_val buffer"| APP["Application Tasks"]
    
    KEYS --> GPIO_IN
    GPIO_IN -.->|"GPIO_ReadPin()"| APP
    
    RTC -.->|"Time/Date"| APP
    TIM2 -.->|"10ms tick"| APP
    TIM7 -.->|"100ms tick"| APP
    
    APP --> FSMC
    FSMC --> LCD
    
    APP --> TIM4
    TIM4 --> BEEPER
    
    APP --> GPIO_OUT
    GPIO_OUT --> LEDS
    
    APP --> USART
    USART --> DMA1
    DMA1 --> DEBUG
```

**Critical Dependencies:**
- **ADC3 requires DMA2** to be initialized first for continuous conversion mode
- **USART1 requires DMA1** for efficient transmit/receive operations
- **FSMC must be ready** before LCD initialization in application tasks
- **GPIO must configure alternate functions** before timer PWM output works

**Sources: ** [.mxproject:26-32](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L26-L32)

## HAL Module Selection

The HAL modules are selectively enabled in `stm32f1xx_hal_conf.h` to minimize code size and compilation time. The following modules are enabled for this project:

```mermaid
graph TB
    subgraph "Core HAL Modules - Always Enabled"
        HAL_CORE["HAL_MODULE_ENABLED"]
        HAL_RCC["HAL_RCC_MODULE"]
        HAL_GPIO_EN["HAL_GPIO_MODULE"]
        HAL_CORTEX["HAL_CORTEX_MODULE"]
        HAL_DMA_EN["HAL_DMA_MODULE"]
        HAL_FLASH["HAL_FLASH_MODULE"]
        HAL_PWR["HAL_PWR_MODULE"]
        HAL_EXTI["HAL_EXTI_MODULE"]
    end
    
    subgraph "Peripheral HAL Modules - Project Specific"
        HAL_ADC_EN["HAL_ADC_MODULE<br/>Line 37"]
        HAL_RTC_EN["HAL_RTC_MODULE<br/>Line 60"]
        HAL_SRAM_EN["HAL_SRAM_MODULE<br/>Line 66"]
        HAL_TIM_EN["HAL_TIM_MODULE<br/>Line 67"]
        HAL_UART_EN["HAL_UART_MODULE<br/>Line 68"]
    end
    
    subgraph "Disabled Modules - Not Used"
        DISABLED["CAN, CEC, CRC, DAC<br/>ETH, I2C, I2S, IRDA<br/>SPI, USART, WWDG<br/>etc."]
    end
```

**Enabled Modules:**
- **HAL_ADC_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:37]()) - For light sensor reading
- **HAL_DMA_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:45,73]()) - For ADC and USART transfers
- **HAL_GPIO_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:48,76]()) - For digital I/O
- **HAL_RTC_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:60]()) - For calendar/clock
- **HAL_SRAM_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:66]()) - For FSMC/LCD interface
- **HAL_TIM_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:67]()) - For timers and PWM
- **HAL_UART_MODULE_ENABLED** ([stm32f1xx_hal_conf.h:68]()) - For serial communication

**Sources: ** [Core/Inc/stm32f1xx_hal_conf.h:36-78](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Inc/stm32f1xx_hal_conf.h#L36-L78)

## Peripheral Driver Files

Each peripheral has dedicated source and header files generated by STM32CubeMX:

| Peripheral | Header File | Source File | Key Functions |
|------------|-------------|-------------|---------------|
| **GPIO** | `Core/Inc/gpio.h` | `Core/Src/gpio.c` | `MX_GPIO_Init()` |
| **ADC3** | `Core/Inc/adc.h` | `Core/Src/adc.c` | `MX_ADC3_Init()` |
| **DMA** | `Core/Inc/dma.h` | `Core/Src/dma.c` | `MX_DMA_Init()` |
| **FSMC** | `Core/Inc/fsmc.h` | `Core/Src/fsmc.c` | `MX_FSMC_Init()` |
| **RTC** | `Core/Inc/rtc.h` | `Core/Src/rtc.c` | `MX_RTC_Init()` |
| **Timers** | `Core/Inc/tim.h` | `Core/Src/tim.c` | `MX_TIM2_Init()`, `MX_TIM4_Init()`, `MX_TIM7_Init()` |
| **USART1** | `Core/Inc/usart.h` | `Core/Src/usart.c` | `MX_USART1_UART_Init()` |

**Code Generation Note:** These files are auto-generated by STM32CubeMX from the `.ioc` project file. User code should be placed within `/* USER CODE BEGIN */` and `/* USER CODE END */` comment blocks to survive regeneration.

**Sources: ** [.mxproject:12-37](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L12-L37)

## MSP (MCU Support Package) Functions

The HAL uses MSP callback functions to configure low-level peripheral resources like clocks, pins, and interrupts. These are implemented in `Core/Src/stm32f1xx_hal_msp.c`:

```mermaid
graph TB
    HAL_INIT["HAL Peripheral Init<br/>e.g., HAL_ADC_Init()"]
    MSP_INIT["MSP Init Callback<br/>e.g., HAL_ADC_MspInit()"]
    
    HAL_INIT -->|"Calls"| MSP_INIT
    
    subgraph "MSP Callback Responsibilities"
        CLK["Enable Peripheral Clock<br/>__HAL_RCC_xxx_CLK_ENABLE()"]
        GPIO_CFG["Configure GPIO Pins<br/>HAL_GPIO_Init()"]
        DMA_CFG["Configure DMA<br/>if used"]
        NVIC_CFG["Configure NVIC<br/>HAL_NVIC_SetPriority()"]
    end
    
    MSP_INIT --> CLK
    MSP_INIT --> GPIO_CFG
    MSP_INIT --> DMA_CFG
    MSP_INIT --> NVIC_CFG
```

**MSP Functions per Peripheral:**
- `HAL_ADC_MspInit()` / `HAL_ADC_MspDeInit()` - ADC clock, GPIO, DMA, interrupts
- `HAL_RTC_MspInit()` / `HAL_RTC_MspDeInit()` - RTC clock source selection
- `HAL_TIM_Base_MspInit()` / `HAL_TIM_Base_MspDeInit()` - Timer clocks
- `HAL_TIM_PWM_MspInit()` / `HAL_TIM_PWM_MspDeInit()` - PWM GPIO configuration
- `HAL_UART_MspInit()` / `HAL_UART_MspDeInit()` - UART clock, GPIO, DMA, interrupts

**Sources: ** [.mxproject:34](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L34)

## Peripheral Handle Structures

Each peripheral maintains a handle structure that stores its configuration and state. These handles are typically declared as global variables in the respective peripheral driver files:

| Handle Variable | Type | Defined In | Purpose |
|----------------|------|------------|---------|
| `hadc3` | `ADC_HandleTypeDef` | `Core/Src/adc.c` | ADC3 configuration and state |
| `hdma_adc3` | `DMA_HandleTypeDef` | `Core/Src/dma.c` | DMA for ADC3 transfers |
| `hdma_usart1_rx` | `DMA_HandleTypeDef` | `Core/Src/dma.c` | DMA for USART1 RX |
| `hdma_usart1_tx` | `DMA_HandleTypeDef` | `Core/Src/dma.c` | DMA for USART1 TX |
| `hsram4` | `SRAM_HandleTypeDef` | `Core/Src/fsmc.c` | FSMC Bank 4 for LCD |
| `hrtc` | `RTC_HandleTypeDef` | `Core/Src/rtc.c` | RTC configuration |
| `htim2` | `TIM_HandleTypeDef` | `Core/Src/tim.c` | TIM2 time base |
| `htim4` | `TIM_HandleTypeDef` | `Core/Src/tim.c` | TIM4 PWM |
| `htim7` | `TIM_HandleTypeDef` | `Core/Src/tim.c` | TIM7 time base |
| `huart1` | `UART_HandleTypeDef` | `Core/Src/usart.c` | USART1 serial port |

These handle structures are passed to HAL API functions for all peripheral operations.

**Sources: ** [.mxproject:26-32](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/.mxproject#L26-L32) (structure names follow STM32 HAL naming convention)

## System Clock Requirements

Different peripherals derive their clocks from different sources in the clock tree:

| Peripheral | Clock Source | Typical Frequency | Notes |
|------------|--------------|-------------------|-------|
| **GPIO** | AHB Bus | 72 MHz | From HCLK |
| **ADC3** | APB2 with Prescaler | ≤14 MHz | ADC clock must not exceed 14 MHz |
| **DMA1/DMA2** | AHB Bus | 72 MHz | Direct access to system bus |
| **FSMC** | AHB Bus | 72 MHz | High-speed memory interface |
| **RTC** | LSI (Low-Speed Internal) | 40 kHz | Independent of system clock |
| **TIM2** | APB1 Timer Clock | 72 MHz | 2x multiplier if APB1 prescaler > 1 |
| **TIM4** | APB1 Timer Clock | 72 MHz | 2x multiplier if APB1 prescaler > 1 |
| **TIM7** | APB1 Timer Clock | 72 MHz | 2x multiplier if APB1 prescaler > 1 |
| **USART1** | APB2 | 72 MHz | For baud rate generation |

For detailed clock tree configuration, see [System Initialization](#3.2).

**Sources: ** [Core/Inc/stm32f1xx_hal_conf.h:86-122](https://github.com/BA2F/STM32-TFTLCD-UI/blob/e0f407ee/Core/Inc/stm32f1xx_hal_conf.h#L86-L122)

## Related Pages

For detailed information about specific peripherals:
- **[GPIO Configuration](#4.1)** - Pin assignments, modes, and interrupt configuration
- **[ADC and Light Sensor](#4.2)** - ADC3 setup for photoresistor reading with DMA
- **[Display Interface (FSMC)](#4.3)** - Memory-mapped LCD interface via FSMC Bank 4
- **[Real-Time Clock](#4.4)** - RTC configuration for calendar and timekeeping
- **[Timer Peripherals](#4.5)** - TIM2/4/7 configurations for time base and PWM
- **[Serial Communication (USART)](#4.6)** - USART1 with DMA for debugging
- **[DMA System](#4.7)** - DMA controller configuration and channel allocation

For system-level architecture:
- **[System Architecture](#1.2)** - High-level system overview
- **[HAL Configuration](#3.1)** - HAL module selection and configuration
- **[System Initialization](#3.2)** - Startup sequence and clock configuration